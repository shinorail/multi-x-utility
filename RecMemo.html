<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>NativeMemo Pro</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root {
--bg: #000;
--card: #1c1c1e;
--text: #fff;
--accent: #32d74b;
--danger: #ff453a;
}
body {
font-family: -apple-system, sans-serif;
background: var(--bg);
color: var(--text);
margin: 0;
height: 100vh;
display: flex;
flex-direction: column;
overflow: hidden;
}
/* ブラウザ閲覧時のブロック画面 /
#blocker {
display: flex; flex-direction: column; justify-content: center;
align-items: center; height: 100vh; padding: 40px; text-align: center;
background: #000; z-index: 9999;
}
/ アプリ本体：初期状態は非表示 */
#app { display: none; flex-direction: column; height: 100%; }

    header { padding: 60px 20px 10px; font-size: 24px; font-weight: bold; border-bottom: 0.5px solid #333; }
    main { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }
    
    textarea {
        width: 100%; height: 180px; background: var(--card); border: none;
        border-radius: 16px; color: var(--text); padding: 15px;
        box-sizing: border-box; font-size: 16px; margin-bottom: 20px;
        outline: none; -webkit-appearance: none;
    }
    
    .btn {
        width: 100%; padding: 20px; border-radius: 16px; border: none;
        font-weight: bold; font-size: 16px; margin-bottom: 15px; cursor: pointer;
        transition: opacity 0.2s;
    }
    .btn:active { opacity: 0.7; }
    .btn-rec { background: var(--danger); color: white; }
    .btn-stop { background: #444; color: white; }
    .btn-clear { background: #1c1c1e; color: #ff453a; font-size: 13px; margin-top: 30px; border: 0.5px solid #333; }
    
    .audio-item { background: var(--card); padding: 15px; border-radius: 16px; margin-bottom: 15px; }
    audio { width: 100%; height: 40px; }
    .info-tag { font-size: 10px; color: var(--accent); text-align: center; margin-bottom: 15px; letter-spacing: 1px; }
</style>
</head>
<body>

<div id="blocker">
<h1 style="font-size: 24px; margin-bottom: 10px;">Native Application Required</h1>
<p style="color: #888; line-height: 1.6; font-size: 14px;">
ブラウザ上では「振って停止」や「録音」等の全機能がロックされています。




共有メニューから


<strong>「ホーム画面に追加」</strong>


して起動してください。
</p>
</div>

<div id="app">
<header>NativeMemo Pro</header>
<main>
<div class="info-tag">UNLIMITED APP MODE ACTIVE</div>
<textarea id="memo" placeholder="メモを入力... (自動保存)"></textarea>

    <button id="recBtn" class="btn btn-rec">REC START</button>
    <button id="stopBtn" class="btn btn-stop" style="display:none;">STOP (or SHAKE)</button>

    <div id="list"></div>
    <button id="clearBtn" class="btn btn-clear">全録音データをリセット</button>
</main>
</div>

<script>
const app = document.getElementById('app');
const blocker = document.getElementById('blocker');
const memo = document.getElementById('memo');
const recBtn = document.getElementById('recBtn');
const stopBtn = document.getElementById('stopBtn');
const clearBtn = document.getElementById('clearBtn');
const list = document.getElementById('list');

// 強力なスタンドアロン判定
const isStandalone = window.navigator.standalone === true || 
                     window.matchMedia(&#39;(display-mode: standalone)&#39;).matches;

if (isStandalone) {
    // アプリ起動時のみUIを表示し、全機能を解凍
    blocker.style.display = &#39;none&#39;;
    app.style.display = &#39;flex&#39;;
    initNativeApp();
} else {
    // ブラウザ起動時は全イベントを無効化
    console.log(&quot;Browser mode: Sensors and Recording are disabled.&quot;);
}

function initNativeApp() {
    let recorder;
    let chunks = [];
    let isRecording = false;

    // メモ保存
    memo.value = localStorage.getItem(&#39;pro_memo_data&#39;) || &#39;&#39;;
    memo.addEventListener(&#39;input&#39;, () =&gt; {
        localStorage.setItem(&#39;pro_memo_data&#39;, memo.value);
    });

    // 録音履歴
    loadHistory();

    // 【限定機能】スマホを振って停止（ブラウザでは動作しない）
    window.addEventListener(&#39;devicemotion&#39;, (e) =&gt; {
        if (!isRecording) return;
        const acc = e.acceleration;
        if (!acc) return;
        const sensitivity = 15;
        if (Math.abs(acc.x) &gt; sensitivity || Math.abs(acc.y) &gt; sensitivity || Math.abs(acc.z) &gt; sensitivity) {
            stopRecording();
        }
    });

    // 【限定機能】録音開始（ブラウザでは動作しない）
    recBtn.onclick = async () =&gt; {
        try {
            if (typeof DeviceMotionEvent.requestPermission === &#39;function&#39;) {
                await DeviceMotionEvent.requestPermission();
            }
            
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorder = new MediaRecorder(stream);
            chunks = [];

            recorder.ondataavailable = (e) =&gt; chunks.push(e.data);
            recorder.onstop = async () =&gt; {
                const blob = new Blob(chunks, { type: &#39;audio/webm&#39; });
                const base64 = await toBase64(blob);
                saveData(base64);
                addUI(base64);
            };

            recorder.start();
            isRecording = true;
            recBtn.style.display = &#39;none&#39;;
            stopBtn.style.display = &#39;block&#39;;
        } catch (err) {
            alert(&#39;マイクとセンサーの許可をオンにしてください。&#39;);
        }
    };

    stopBtn.onclick = stopRecording;

    function stopRecording() {
        if (recorder &amp;&amp; recorder.state !== &#39;inactive&#39;) {
            recorder.stop();
            isRecording = false;
            recBtn.style.display = &#39;block&#39;;
            stopBtn.style.display = &#39;none&#39;;
        }
    }

    function toBase64(blob) {
        return new Promise((r) =&gt; {
            const reader = new FileReader();
            reader.onloadend = () =&gt; r(reader.result);
            reader.readAsDataURL(blob);
        });
    }

    function saveData(b64) {
        let history = JSON.parse(localStorage.getItem(&#39;pro_audio_history&#39;) || &#39;[]&#39;);
        history.unshift({ time: new Date().toLocaleString(), data: b64 });
        try {
            localStorage.setItem(&#39;pro_audio_history&#39;, JSON.stringify(history));
        } catch (e) {
            alert(&#39;端末の容量が限界です。不要な音声を削除してください。&#39;);
        }
    }

    function loadHistory() {
        const history = JSON.parse(localStorage.getItem(&#39;pro_audio_history&#39;) || &#39;[]&#39;);
        history.forEach(item =&gt; addUI(item.data));
    }

    function addUI(b64) {
        const div = document.createElement(&#39;div&#39;);
        div.className = &#39;audio-item&#39;;
        div.innerHTML = `&lt;audio src=&quot;${b64}&quot; controls&gt;&lt;/audio&gt;`;
        list.prepend(div);
    }

    clearBtn.onclick = () =&gt; {
        if (confirm(&#39;すべての録音データを消去しますか？&#39;)) {
            localStorage.removeItem(&#39;pro_audio_history&#39;);
            list.innerHTML = &#39;&#39;;
        }
    };
}
</script>

</body>
</html>
